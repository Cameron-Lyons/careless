name: Version Check

on:
  pull_request:
    branches: [main]
  workflow_call:

jobs:
  version-check:
    name: Check version updated
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version from PR branch
        id: pr_version
        run: |
          VERSION=$(grep -Po '(?<=^version = ")[^"]+' pyproject.toml)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "PR branch version: $VERSION"

      - name: Get version from main branch
        id: main_version
        run: |
          git fetch origin main
          VERSION=$(git show origin/main:pyproject.toml | grep -Po '(?<=^version = ")[^"]+')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Main branch version: $VERSION"

      - name: Compare versions
        run: |
          PR_VERSION="${{ steps.pr_version.outputs.version }}"
          MAIN_VERSION="${{ steps.main_version.outputs.version }}"

          echo "PR version: $PR_VERSION"
          echo "Main version: $MAIN_VERSION"

          if [ "$PR_VERSION" = "$MAIN_VERSION" ]; then
            echo "::error::Version has not been updated. Please bump the version in pyproject.toml"
            exit 1
          fi

          echo "Version has been updated from $MAIN_VERSION to $PR_VERSION"
